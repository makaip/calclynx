<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Line Math Field Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-editor { 
            border: 2px solid #007bff; 
            padding: 15px; 
            min-height: 100px; 
            background: white; 
            outline: none; 
            font-family: 'Times New Roman', serif; 
            font-size: 16px; 
            margin: 20px 0;
        }
        .mq-inline { 
            display: inline-block; 
            background: #e8f4fd; 
            border: 1px solid #bee5eb; 
            padding: 3px 6px; 
            margin: 0 2px; 
            border-radius: 3px; 
        }
        pre { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            padding: 10px; 
            border-radius: 5px; 
            font-size: 12px; 
        }
    </style>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.min.js"></script>
</head>
<body>
    <h1>Test: Adding Math Field to Second Line</h1>
    
    <div>
        <h3>Test Case: Math field added to second line should NOT collapse</h3>
        <div id="testEditor" class="test-editor" contenteditable="true">
            First line text
            <div>Second line - press $ here to add math</div>
        </div>
        
        <button onclick="showStructure()">Show Structure</button>
        <button onclick="resetTest()">Reset</button>
    </div>
    
    <div>
        <h3>HTML Structure:</h3>
        <pre id="structure"></pre>
    </div>

    <script>
        const MQ = window.MathQuill ? window.MathQuill.getInterface(2) : null;
        
        function initializeMathFields() {
            if (!MQ) return;
            document.querySelectorAll('.mq-inline:not([data-initialized])').forEach(span => {
                try {
                    const latex = span.dataset.latex || '';
                    if (latex) {
                        MQ.StaticMath(span).latex(latex);
                    }
                    span.dataset.initialized = 'true';
                } catch (e) {
                    console.warn('Failed to initialize math field:', e);
                }
            });
        }
        
        function resetTest() {
            const editor = document.getElementById('testEditor');
            editor.innerHTML = 'First line text<div>Second line - press $ here to add math</div>';
            showStructure();
        }
        
        function showStructure() {
            const editor = document.getElementById('testEditor');
            const structureDiv = document.getElementById('structure');
            structureDiv.textContent = editor.innerHTML;
        }
        
        // Simple math field insertion for testing
        document.getElementById('testEditor').addEventListener('keydown', (ev) => {
            if (ev.key === '$') {
                ev.preventDefault();
                const sel = window.getSelection();
                if (!sel.rangeCount) return;

                const range = sel.getRangeAt(0);
                const span = document.createElement('span');
                span.className = 'mq-inline';
                span.dataset.latex = 'x^2';
                span.textContent = 'xÂ²';

                range.deleteContents();
                range.insertNode(span);
                
                // Move cursor after the math field
                const afterNode = document.createTextNode(' ');
                span.parentNode.insertBefore(afterNode, span.nextSibling);
                
                range.setStart(afterNode, 1);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
                
                setTimeout(() => {
                    initializeMathFields();
                    showStructure();
                }, 10);
            }
        });
        
        document.getElementById('testEditor').addEventListener('input', () => {
            setTimeout(showStructure, 10);
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initializeMathFields();
                showStructure();
            }, 100);
        });
    </script>
</body>
</html>
